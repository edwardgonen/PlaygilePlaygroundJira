<tr class="mod-header">
    <h3>$i18n.getText('metrics--page--item.label') for $project.name</h3>
    <!--img style="-webkit-user-select: none" src="https://chart.googleapis.com/chart?cht=p&chs=380x200&chd=t:41,55,4&chl=41%|55%|4%&chdl=Cash|Credit_Card|Check&chco=26AD21|1D82C4|F0A016"-->



    <html>
    <head>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">

            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            function drawChart() {
                if (!'$allisok') return;

                const LINE_SEPARATOR = ",";
                const PAIR_SEPARATOR = "|";
                const DATE_FORMAT = "MM/dd/yyyy";

                var data = new google.visualization.DataTable();
                data.addColumn('date', 'Date');
                data.addColumn('number', 'Ideal');
                data.addColumn('number', 'Predicted');

                var chartRows = '$chartrows';
                //split and parse
                if (typeof chartRows === 'undefined' || chartRows === null)
                {
                    alert("No rows for the chart");
                    return;
                }

                var lines = chartRows.split(LINE_SEPARATOR);
                if (lines.length <= 0)
                {
                    alert("Wrong rows format " + chartRows);
                    return;
                }
                lines.forEach(function (line, index) {
                    if (line.length > 0)//non empty line
                    {
                        //split by pair separator
                        var items = line.split(PAIR_SEPARATOR);
                        if (items.length < 3)
                        {
                            alert("Wrong line format " + line);
                        }

                        var date = new Date(items[0]);

                        var ideal = parseFloat(items[1]);
                        if (isNaN(ideal)) ideal = null;

                        var predicted = parseFloat(items[2]);
                        if (isNaN(predicted)) predicted = null;

                        data.addRow([date, ideal, predicted]);
                        //data.addRow([new Date(2010, 1, 1),  37.8, 80.8]);
                    }
                });
                var options = {
                    title: 'Project Monitor ',
                    curveType: 'function',
                    legend: { position: 'bottom' }
                };

                var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

                chart.draw(data, options);

            }
            function OnRecalculateClick()
            {
                var velocity = document.getElementById("velocity").value;
                var releaseversion = document.getElementById("releaseversion").value;
                jQuery.ajax({
                    type: "GET",
                    url: "/jira/plugins/servlet/activeobjectsaccess?projectKey=" + '$project.getKey()'
                        + "&teamVelocity=" + velocity + "&releaseVersion=" + releaseversion,
                    success: function(data) {
                        //alert(data);
                        location.reload();
                    },
                    error: function() {
                        alert("error");
                        //console.log('error', arguments);
                    }
                });

                //window.onbeforeunload = null;

            }
        </script>
    </head>
        <body>
            #if (!$allisok)
                <h2>$messagetodisplay</h2>
            #end
            <form id="admin" class="aui">
                <tr>
                <tr class="field-group">
                    <label for="versionlabel">Release version</label>
                    <select id="releaseversion" name="releaseversion">
                        #foreach( $version in $projectversions )
                            #if ($version == $selectedprojectversion)
                                <option value="$version" selected="selected">$version</option>
                            #else
                                <option value="$version">$version</option>
                            #end
                        #end
                    </select>
                </tr>
                <tr class="field-group">
                    <label for="velocity">Team's velocity</label>
                    <input type="number" id="velocity" value=$teamvelocity name="velocity" class="text" min="0" max="1000" style="width: 10em;">
                </tr>
                <tr class="field-group">
                    <input type="submit" value="Recalculate" class="button" onClick="OnRecalculateClick()">
                </tr>
                </tr>
            </form>
            #if ($allisok)
                <table>
                    <tr>
                        <td>
                            <div id="curve_chart" style="width: 900px; height: 500px"></div>
                        </td>
                        <td>
                            kkkk
                        </td>
                        <td>
                            1111
                        </td>
                    </tr>
                </table>
            #end
        </body>
    </html>


    <table>
        <tr>
            <td>Active Object result</td><td>$aoresult</td>
        </tr>
        <tr>
            <td>Issue info</td>
            <td>
                $issue.getSummary()
            </td>
            <td>
                $issue.getStatusObject().getName()
            </td>
            <td>
                $issue.getId()
            </td>
            <td>
                $storypoints
            </td>
            <td>
                $sprintinfo.toString()
            </td>
        </tr>
        <div style="height:120px;width:500px;border:1px solid #ccc;font:16px/26px Georgia, Garamond, Serif;overflow:auto;">
            $statustext
        </div>
    </table>
</div>

<tr class="mod-header">
    <h3>Playgile Studio Total View for $project.name ($project.getKey())</h3>

<html>
<head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    $webResourceManager.requireResourcesForContext("playgilePlugin")
    <script type="text/javascript">
    /*
        google.charts.load('current', {'packages':['corechart']});
        google.charts.load('current', {'packages':['gauge']});
        google.charts.load('current', {'packages':['timeline']});
        google.charts.setOnLoadCallback(drawChart);*/

        function drawChart() {
            if (!$allisok) return; //no need to execute
            /////////// project predictions
            const LINE_SEPARATOR = "BOBRUISK";
            const PAIR_SEPARATOR = "|";
            const DATE_FORMAT = "MM/dd/yyyy";

            //split by lines
            var featureRows = '$featuresrows';
            //split and parse
            if (typeof featureRows === 'undefined' || featureRows === null)
            {
                alert("No rows for the page");
                return;
            }

            var lines = featureRows.split(LINE_SEPARATOR);
            if (lines.length <= 0)
            {
                alert("Wrong rows format " + featureRows);
                return;
            }
            // Find a <table> element with id="myTable":
            var table = document.getElementById("roadmap-features-table");
            var rowHeight = 100;
            lines.forEach(function (line, index) {
                if (line.length > 0)//non empty line
                {
                    //split by pair separator
                    var items = line.split(PAIR_SEPARATOR);
                    if (items.length < 11)
                    {
                        alert("Wrong line format " + line);
                    }

                    //add new row to table
                    // Create an empty <tr> element and add it to the 1st position of the table:
                    var row = table.insertRow(index);

                    //////////////////////////////////////////
                    var createClickHandler =
                            function(row)
                            {
                                return function() {
                                    var cell = row.getElementsByTagName("td")[2];
                                    var encodedFeatureName = encodeURIComponent(cell.innerText);
                                    jQuery.ajax({
                                        type: "GET",
                                        async: false,
                                        url: '$baseurl' + "/plugins/servlet/activeobjectsaccess?projectKey=" + '$project.getKey()'
                                        + "&roadmapfeature=" + encodedFeatureName + "&user=" + '$currentuser',
                                        success: function(data) {
                                            var newUrl = window.location.href.replace('totalview', 'metrics');
                                            window.location.href = newUrl;
                                        },
                                        error: function() {
                                            alert("error");
                                            //console.log('error', arguments);
                                        }
                                    });
                                };
                            };

                    row.onclick = createClickHandler(row);

                    //////////////////////////////////////////

                    var featureStatus = parseFloat(items[1]);
                    var featureStatusCell = row.insertCell(0);
                    featureStatusCell.width = 100;
                    featureStatusCell.height = rowHeight;
                    featureStatusCell.id = "feature-status" + index;
                    var dataStatusGauge = google.visualization.arrayToDataTable([
                        ['Label', 'Value'],
                        ['Risk', 100 - featureStatus],
                    ]);
/*
                    var featureStatusGaugeOptions = {
                        width: 100, height: rowHeight,
                        redFrom: 0, redTo: 50,
                        yellowFrom:50, yellowTo: 70,
                        greenFrom: 70, greenTo: 100,
                        minorTicks: 5
                    };
*/
                    var featureStatusGaugeOptions = {
                        width: 100, height: rowHeight,
                        redFrom: 50, redTo: 100,
                        yellowFrom: 25, yellowTo: 50,
                        greenFrom: 0, greenTo: 25,
                        minorTicks: 0
                    };

                    var featureStautsGauge = new google.visualization.Gauge(document.getElementById(featureStatusCell.id));

                    featureStautsGauge.draw(dataStatusGauge, featureStatusGaugeOptions);

                    ///////////////////////////////////////////////////////////////

                    var featureName = items[0];
                    var featureNameCell = row.insertCell(1);
                    featureNameCell.width = 120;
                    featureNameCell.height = rowHeight;
                    featureNameCell.innerText = featureName;
                    featureNameCell.id = "feature-name";


                    /////////////////////////////////////////////////////////////////////////

                    var startDate = new Date(items[2]);
                    var startDateCell = row.insertCell(2);
                    startDateCell.width = 120;
                    startDateCell.height = rowHeight;
                    startDateCell.innerText = 'Started on ' + startDate.toDateString();

                    ////////////////////////////////////////////////////////////////////////

                    var teamVelocity = parseFloat(items[3]);
                    var projectVelocity = parseFloat(items[4]);
                    var velocityCell = row.insertCell(3);
                    velocityCell.width = '40%';
                    velocityCell.height = rowHeight;
                    velocityCell.id = "velocities" + index;

                    var dataVelocities = google.visualization.arrayToDataTable([
                        ['', 'Predicted', 'Real'],
                        ['', teamVelocity, projectVelocity]
                    ]);

                    var optionsVelocities = {
                        title: 'Velocities',
                        legend: 'none',
                        chartArea: {width: '50%'},
                        colors: ['#4285f4', '#009900'],
                        bar: {groupWidth: "60%"},
                        hAxis: {
                            title: 'Story Points per Sprint',
                            minValue: 0
                        }
                    };
                    var chartVelocities = new google.visualization.BarChart(document.getElementById(velocityCell.id));
                    chartVelocities.draw(dataVelocities, optionsVelocities);


                    //////////////////////////////////////////////////////////////////////////

                    var idealEndOfProject = new Date(items[5]);
                    var predictedEndOfProject = new Date(items[6]);
                    var projectEndCell = row.insertCell(4);
                    projectEndCell.width = '20%';
                    projectEndCell.height = rowHeight;
                    projectEndCell.id = "project-end" + index;

                    var dataProjectEnd = new google.visualization.DataTable();
                    dataProjectEnd.addColumn('string', '');
                    dataProjectEnd.addColumn('date', 'Start');
                    dataProjectEnd.addColumn('date', 'End');

                    dataProjectEnd.addRows([
                        ['Predicted', startDate, idealEndOfProject],
                        ['Real', startDate, predictedEndOfProject],
                    ]);

                    var optionsProjectEnd = {
                        height: rowHeight,
                        colors: ['#4285f4', items[11]],
                        timeline: {
                            rowLabelStyle: { fontSize: 10 },
                            barLabelStyle: { fontSize: 5 }
                        }
                    };

                    var chartProjectEnd = new google.visualization.Timeline(document.getElementById(projectEndCell.id));
                    chartProjectEnd.draw(dataProjectEnd, optionsProjectEnd);

                    ////////////////////////////////////////////////////////////////////
                    var notEstimatedNumber = parseFloat(items[7]);
                    var largeStoriesNumber =  parseFloat(items[8]);
                    var veryLargeStoriesNumber =  parseFloat(items[9]);
                    var estimatedStoriesNumber =  parseFloat(items[10]);

                    var issueDistributionCell = row.insertCell(5);
                    issueDistributionCell.width = '10%';
                    issueDistributionCell.height = rowHeight;
                    issueDistributionCell.id = "issues-estimation" + index;

                    var dataIssueDistribution = new google.visualization.DataTable();

                    dataIssueDistribution.addColumn('string', 'Category');
                    dataIssueDistribution.addColumn('number', 'Value');

                    dataIssueDistribution.addRow(['Not estimated', notEstimatedNumber]);
                    dataIssueDistribution.addRow(['Very Large (21 points)', veryLargeStoriesNumber]);
                    dataIssueDistribution.addRow(['Large (13 points)', largeStoriesNumber]);
                    dataIssueDistribution.addRow(['Normal', estimatedStoriesNumber]);

                    var totalStories = notEstimatedNumber + largeStoriesNumber + veryLargeStoriesNumber + estimatedStoriesNumber;

                    var optionsIssueDistribution = {
                        title: 'Total ' + totalStories + ' issues',
                        legend: 'none'
                    };

                    var chartIssueDistribution = new google.visualization.PieChart(document.getElementById(issueDistributionCell.id));

                    chartIssueDistribution.draw(dataIssueDistribution, optionsIssueDistribution);
                }
            });

        }
    </script>
</head>
<body>
#if (!$allisok)
<script>
    var dialog = new AJS.Dialog({
        id: "message-status-dialog",
        closeOnOutsideClick: false
    });

    dialog.addHeader("Playgile Studio View");
    dialog.addPanel("Panel 1", '<h1 style="color:red">$messagetodisplay</h1>', "panel-body");

    dialog.addButton("OK", function (dialog) {
        dialog.hide();
    }, "#");
    dialog.show();
</script>
<h1 style="color:red">$messagetodisplay</h1>
#end

#if ($allisok)
<div class="content">
        <div class="generalLoading">
            generalLoading
        </div>
    <div class="generalViewBlock">
            <table class="generalViewTable" width="100%">
            </table>
    </div>
</div>
<table id="roadmap-features-table"; width="100%">
</table>


#end
<script>
window.onload = function() {
    google.charts.load('current', {'packages':['corechart']});
        google.charts.load('current', {'packages':['gauge']});
        google.charts.load('current', {'packages':['timeline']});
        google.charts.setOnLoadCallback(init);
  };
function init() {
    console.log('loaded resources playgilePlugin and init v1');

    const PROJECT_NAME = /[^/]*$/.exec(location.pathname);

    const BASE_URL = location.origin;

    const FEATURES_URL = BASE_URL + '/plugins/servlet/getActiveFeatures?projectKey=' + PROJECT_NAME;

    const GET_FEATURE_DATA_URL = BASE_URL + '/plugins/servlet/getAnalyzedFeature?projectKey=' + PROJECT_NAME + '&roadmapFeature=';

    const $generalLoading = $('.generalLoading');

    const $generalViewBlock = $('.generalViewBlock');

    const $generalViewTable = $('.generalViewTable')

    const STORE = {
        featureArray: [],
        viewChildren: [],
        $currentBlockInLoading: null
    };
    console.log('STORE');
    console.log(STORE)

    globalLoadingOFF()


    doPost(FEATURES_URL, {}, function (data) {
        STORE.featureArray = data.featuresList
        console.log(data)
        initBuildPanels()
    })

    function initBuildPanels() {
        if (STORE.featureArray.length != STORE.viewChildren.length) {
            var featureId = encodeURIComponent(STORE.featureArray[STORE.viewChildren.length])
            var $panelBlock = $('<div>').text('Loading');
            $generalViewBlock.append($panelBlock)
            STORE.$currentBlockInLoading = $panelBlock;
            STORE.viewChildren.push($panelBlock);
            doPost(GET_FEATURE_DATA_URL + featureId, {}, function (data) {
                if (!!data.statusMessage) {
                    $panelBlock.hide()
                    initBuildPanels()
                } else {
                    $panelBlock.empty();
                    $panelBlock.append($(getTotalViewBlock(data)));
                    console.log(data)
                    initBuildPanels()
                }

            })
        }


    }

    function globalLoadingON() {
        $generalLoading.show()
    }

    function globalLoadingOFF() {
        $generalLoading.hide()
    }

    function doPost(url, postData, callback) {
        globalLoadingON()
        jQuery.post(url, postData)
            .done(function (textData) {
                var jsonData = JSON.parse(textData)
                if (!!jsonData.statusMessage) { traceDataMessageError(jsonData) }
                callback(jsonData)
                globalLoadingOFF()
            })
            .fail(function (err) {
                alert("POST error")
                globalLoadingOFF()
            })
    }
    function traceDataMessageError(data) {
        console.log('----------------data.statusMessage----ERROR---------------')
        console.log(data.statusMessage)
        console.log(data)
    }

    function getTotalViewBlock(featureData) {

        const SUMMARY = featureData.summary;//[0]

        const QUALITY_SCORE = normolizedInt(featureData.qualityScore);//[1]

        const START_DATE_ROADMAP_FEATURE = normolizedDate(featureData.startDateRoadmapFeature);//[2]

        const PLANNED_VELOCITY = normolizedInt(featureData.plannedRoadmapFeatureVelocity);//[3]

        //NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE
        const PROJECT_VELOCITY = normolizedInt(13);//[4] I dont know how find it

        const IDEAL_PROJECT_END = normolizedDate(featureData.idealProjectEnd);//[5]

        const PREDICTED_PROJECT_END = normolizedDate(featureData.predictedProjectEnd);//[6]

        const NOT_ESTIMATED_STORIES_NUMBER = normolizedInt(featureData.notEstimatedStoriesNumber);//[7]

        const LARGE_STORIES_NUMBER = normolizedInt(featureData.largeStoriesNumber);//[8]

        const VERY_LARGE_STORIES_NUMBER = normolizedInt(featureData.veryLargeStoriesNumber);//[9]

        const ESTIMATED_STORIES_NUMBER = normolizedInt(featureData.estimatedStoriesNumber);//[10]

        const LINE_COLOR1 = '#4285f4'
        const LINE_COLOR2 = "#cccc00"//[11]


        const ROW_HEIGHT = 100;
        const ROW_WIDTH = 100;
        const LABEL = 'Label';
        const VALUE = 'Value';
        const RISK = 'Risk'

        var table = document.createElement('table');
        table.width = '100%'

        var row = table.insertRow(0);

        var featureStatusCell = row.insertCell(0);
        featureStatusCell.width = ROW_WIDTH;
        featureStatusCell.height = ROW_HEIGHT;

        var dataStatusGauge = google.visualization.arrayToDataTable([
            [LABEL, VALUE],
            [RISK, 100 - QUALITY_SCORE],
        ]);
        var featureStatusGaugeOptions = {
            width: "5%", height: ROW_HEIGHT,
            redFrom: 50, redTo: 100,
            yellowFrom: 25, yellowTo: 50,
            greenFrom: 0, greenTo: 25,
            minorTicks: 0
        };
        var featureStautsGauge = new google.visualization.Gauge(featureStatusCell);

        featureStautsGauge.draw(dataStatusGauge, featureStatusGaugeOptions);
        ///////////////////////////////////////////////////////////////
        var featureNameCell = row.insertCell(1);
        featureNameCell.width = '10%';
        featureNameCell.height = ROW_HEIGHT;
        featureNameCell.innerText = SUMMARY;
        /////////////////////////////////////////////////////////////////////////
        var startDateCell = row.insertCell(2);
        startDateCell.width = "10%";
        startDateCell.height = ROW_HEIGHT;
        startDateCell.innerText = 'Started on ' + START_DATE_ROADMAP_FEATURE.toDateString();
        ////////////////////////////////////////////////////////////////////////
        var velocityCell = row.insertCell(3);
        velocityCell.width = '30%';
        velocityCell.height = ROW_HEIGHT;
        var dataVelocities = google.visualization.arrayToDataTable([
            ['', 'Predicted', 'Real'],
            ['', PLANNED_VELOCITY, PROJECT_VELOCITY]
        ]);
        var optionsVelocities = {
            title: 'Velocities',
            legend: 'none',
            chartArea: { width: '95%' },
            colors: [LINE_COLOR1, '#009900'],
            bar: { groupWidth: "60%" },
            hAxis: {
                title: 'Story Points per Sprint',
                minValue: 0
            }
        };
        var chartVelocities = new google.visualization.BarChart(velocityCell);
        chartVelocities.draw(dataVelocities, optionsVelocities);
        //////////////////////////////////////////////////////////////////////////
        var projectEndCell = row.insertCell(4);
        projectEndCell.width = '30%';
        projectEndCell.height = ROW_HEIGHT;

        var dataProjectEnd = new google.visualization.DataTable();
        dataProjectEnd.addColumn('string', '');
        dataProjectEnd.addColumn('date', 'Start');
        dataProjectEnd.addColumn('date', 'End');

        dataProjectEnd.addRows([
            ['Predicted', START_DATE_ROADMAP_FEATURE, IDEAL_PROJECT_END],
            ['Real', START_DATE_ROADMAP_FEATURE, PREDICTED_PROJECT_END],
        ]);

        var optionsProjectEnd = {
            height: ROW_HEIGHT,
            colors: [LINE_COLOR1, LINE_COLOR2],
            timeline: {
                rowLabelStyle: { fontSize: 10 },
                barLabelStyle: { fontSize: 5 }
            }
        };

        var chartProjectEnd = new google.visualization.Timeline(projectEndCell);
        chartProjectEnd.draw(dataProjectEnd, optionsProjectEnd);

        ////////////////////////////////////////////////////////////////////
        var issueDistributionCell = row.insertCell(5);
        issueDistributionCell.width = '5%';
        issueDistributionCell.height = ROW_HEIGHT;

        var dataIssueDistribution = new google.visualization.DataTable();

        dataIssueDistribution.addColumn('string', 'Category');
        dataIssueDistribution.addColumn('number', 'Value');

        dataIssueDistribution.addRow(['Not estimated', NOT_ESTIMATED_STORIES_NUMBER]);
        dataIssueDistribution.addRow(['Very Large (21 points)', VERY_LARGE_STORIES_NUMBER]);
        dataIssueDistribution.addRow(['Large (13 points)', LARGE_STORIES_NUMBER]);
        dataIssueDistribution.addRow(['Normal', ESTIMATED_STORIES_NUMBER]);

        var totalStories = NOT_ESTIMATED_STORIES_NUMBER + LARGE_STORIES_NUMBER + VERY_LARGE_STORIES_NUMBER + ESTIMATED_STORIES_NUMBER;

        var optionsIssueDistribution = {
            title: 'Total ' + totalStories + ' issues',
            legend: 'none'
        };

        var chartIssueDistribution = new google.visualization.PieChart(issueDistributionCell);

        chartIssueDistribution.draw(dataIssueDistribution, optionsIssueDistribution);

        return table;
    }
    function normolizedInt(int) {
        if ((typeof int) == 'number') {
            return parseFloat(int)
        } else {
            return null
        }
    }
    function normolizedDate(date) {
        return (new Date(date))
    }
}


</script>
</body>
</html>
<table>
    <div style="height:50px;width:100px;border:1px solid #ccc;font:8px/8px Georgia, Garamond, Serif;overflow:auto;">
        $statustext
    </div>
</table>
</div>
